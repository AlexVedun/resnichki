<div id="admin-div" >
    <div class="row"></div>
    <div class="row">
        <div class="card col s12">
            <div class="card-content" style="padding: 0px">
                <span class="center-align"><h3 class="truncate">Панель администратора</h3></span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col s12">
            <ul class="admin-tabs tabs z-depth-1">
                <li class="tab col s2"><a class="active" href="#manage-users">Пользователи</a></li>
                <li class="tab col s2"><a href="#manage-offers">Предложения</a></li>
                <li class="tab col s2"><a href="#manage-categories">Категории</a></li>
                <li class="tab col s2"><a href="#admin-news">Новость</a></li>
                <li class="tab col s2"><a target="_self" href="#change_password">Изменить пароль</a></li>
            </ul>
        </div>
    <!-- Manage users -->
        <div id="manage-users">
            <div class="row"></div>
            <div class="row">
                <a class="col s12 m8 offset-m2 l6 offset-l3 xl4 offset-xl4 btn waves-effect waves-light" href="#add_user"><i class="material-icons left">add</i>Создать пользователя</a>
            </div>
            <form method="POST" id="manage-users-form" class="card col s12 m12 l12 xl12">
                <div class="card-content">
                    <table class="highlight responsive-table">
                        <thead>
                            <tr>
                                <th>ФИО</th>
                                <th>e-mail</th>
                                <th>Тип</th>
                                <th>Роль</th>
                                <!-- <th>Категория</th>                                 -->
                                <th></th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: usersList">
                            <tr>
                                <!-- <td data-bind="text: name"></td> -->
                                <td><a data-bind="attr: { href: '#user/' + id }, text: name"></a></td>
                                <td data-bind="text: email"></td>
                                <td data-bind="text: type"></td>
                                <td data-bind="text: role"></td>
                                <td><button class="btn waves-effect waves-light red" data-bind="click: function(data) { $root.DeleteUser(data) }"><i class="material-icons">delete</i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    <!-- Manage offers -->
        <div id="manage-offers">
            <div class="row"></div>
            <form method="POST" id="manage-offers-form" class="card col s12 m12 l12 xl12">
                <div class="card-content">
                    <table class="highlight responsive-table">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Категория</th>
                                <th>Заголовок</th>
                                <th>Пользователь</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: offersList">
                            <tr>
                                <td data-bind="text: created_at"></td>
                                <td data-bind="text: category.name"></td>
                                <td><a data-bind="attr: { href: '#offer/' + id }, text: title"></a></td>
                                <td><a data-bind="attr: { href: '#user/' + user.id }, text: user.name"></a></td>
                                <td><button class="btn waves-effect waves-light red" data-bind="click: function(data) { $root.DeleteUser(data) }"><i class="material-icons">delete</i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    <!-- Manage categories -->
        <div id="manage-categories" class="row">
            <div class="row"></div>
            <div class="row">
                <a class="col s12 m8 offset-m2 l6 offset-l3 xl4 offset-xl4 btn waves-effect waves-light" href="#category_editor/0"><i class="material-icons left">add</i>Создать категорию</a>
            </div>
            <div class="col s12 m8 offset-m2 l8 offset-l2 xl8 offset-xl2 card">
                <div class="card-content">
                    <table class="highlight responsive-table">
                        <tbody data-bind="foreach: categoriesList">
                            <tr>
                                <td><img class="materialboxed" data-bind="attr: { src: cover }" style="width: 200px"></td>
                                <td><a data-bind="attr: { href: '#category_editor/' + id }, text: name"></a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    <!-- Admin news -->
        <div id="admin-news" class="row">
            <div class="row"></div>
            <div class="col s12 m8 offset-m2 l8 offset-l2 xl8 offset-xl2 card">
                <div class="card-content">
                    <div class="row">
                        <div class="input-field">
                            <i class="material-icons prefix">mode_edit</i>
                            <textarea name="news" id="news" class="materialize-textarea" data-bind="value: AdminNews.news"></textarea>
                            <label for="news">Написать новость</label>
                        </div>
                    </div>
                    <div class="row">
                        <button class="col s12 m6 offset-m3 l4 offset-l4 xl4 offset-xl4 btn waves-effect waves-light" data-bind="click: SendNews"><i class="left material-icons">send</i>Отправить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let AdminViewModel = {
        // properties
        usersList: ko.observableArray([]),
        categoriesList: ko.observableArray([]),
        offersList: ko.observableArray([]),
        AdminNews: {
            news: ko.observable(''),
        },
        // methods
        UpdateUsers: function() {
            RootViewModel.PreloaderShow();
            $.ajax({
                url: "api/user/get/all",
                type: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token') /* localStorage.getItem('wedding_token') */ );
                }
            }).done(function(resp) {
                AdminViewModel.usersList([]);
                for (const item of resp) {
                    switch(item.type) {
                        case 'ind':
                            item.type = 'Физическое лицо';
                            break;
                        case 'ent':
                            item.type = 'ФЛП';
                            break;
                        case 'firm':
                            item.type = 'Фирма';
                            break;
                    }
                    switch(item.role) {
                        case 'admin':
                            item.role = 'Администратор';
                            break;
                        case 'perf':
                            item.role = 'Исполнитель';
                            break;
                    }
                    AdminViewModel.usersList.push(item);
                }
                M.updateTextFields();
                RootViewModel.PreloaderHide();
            }).fail(function(xhr, status, text) {
                RootViewModel.PreloaderHide();
                HandleError(xhr, '#admin');
                //ShowModalError('#admin', xhr);
                //alert("error: " + text);
            });
        },
        DeleteUser: function(_user) {
            ShowYesNoModal('Внимание!', 'Эта операция необратима! Вы уверены?', '#admin', function() {
                RootViewModel.PreloaderShow();
                $.ajax({
                    url: "api/user/" + _user.id,
                    type: 'DELETE',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token') /* localStorage.getItem('wedding_token') */ );
                    }
                }).done(function(resp) {
                    AdminViewModel.usersList.remove(_user);
                    M.toast({html: 'Успешно удалено!', classes: 'rounded'});
                    RootViewModel.PreloaderHide();
                }).fail(function(xhr, status, text) {
                    RootViewModel.PreloaderHide();
                    HandleError(xhr, '#admin');
                    //alert("error: " + text);
                });
            });
        },
        UpdateCategories: function() {
            RootViewModel.PreloaderShow();
            $.ajax({
                url: "api/categories",
                type: 'GET'
            }).done(function(resp) {
                AdminViewModel.categoriesList([]);
                for (const item of resp) {
                    AdminViewModel.categoriesList.push(item);
                }
                $('.materialboxed').materialbox();
                RootViewModel.PreloaderHide();
            }).fail(function(xhr, status, text) {
                RootViewModel.PreloaderHide();
                HandleError(xhr, '#admin');
                //ShowModalError('#categories', xhr);
                //alert("error: " + text);
            });
        },
        UpdateOffers: function() {
            RootViewModel.PreloaderShow();
            $.ajax({
                url: "api/offers/get/all",
                type: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token') /* localStorage.getItem('wedding_token') */ );
                }
            }).done(function(resp) {
                console.log(resp);
                AdminViewModel.offersList([]);
                for (const item of resp) {
                    AdminViewModel.offersList.push(item);
                }
                //$('.materialboxed').materialbox();
                RootViewModel.PreloaderHide();
            }).fail(function(xhr, status, text) {
                RootViewModel.PreloaderHide();
                HandleError(xhr, '#admin');
                //ShowModalError('#categories', xhr);
                //alert("error: " + text);
            });
        },
        SendNews:function() {
            let formData = ko.toJS(this.AdminNews);
            //formData.append("adminNews", AdminViewModel.adminNews());
            console.log(formData);
            RootViewModel.PreloaderShow();
            $.ajax({
                url: "api/news/add/admin",
                data: formData,
                type: 'POST',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token'));
                }
            }).done(function(resp) {
                M.toast({html: 'Новость добавлена!', classes: 'rounded'});
                RootViewModel.PreloaderHide();
            }).fail(function(xhr, status, text) {
                RootViewModel.PreloaderHide();
                ShowModalError('#admin', xhr);
                //alert("error: " + text);
            });
        },
        ChangePassword: function() {
            // let formData = ko.toJS(this.changePasswordForm);
            // RootViewModel.PreloaderShow();
            // $.ajax({
            //     url: "api/user/password/change",
            //     data: formData,
            //     type: 'POST',
            //     beforeSend: function (xhr) {
            //         xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token') /* localStorage.getItem('wedding_token') */);
            //     }
            // }).done(function(resp) {
            //     M.toast({html: resp.message, classes: 'rounded'});
            //     for (const key in PerformerViewModel.changePasswordForm) {
            //         if (PerformerViewModel.changePasswordForm.hasOwnProperty(key)) {
            //             const element = PerformerViewModel.changePasswordForm[key];
            //             element('');
            //         }
            //     }
            //     RootViewModel.PreloaderHide();
            // }).fail(function(xhr, status, text) {
            //     console.log(xhr);
            //     RootViewModel.PreloaderHide();
            //     ShowModalError('#performer', xhr);
            //     //alert("error: " + text);
            // });
        },
        GetOffersList: function() {
            // RootViewModel.PreloaderShow();
            // $.ajax({
            //     url: "api/offers/get",
            //     type: 'GET',
            //     beforeSend: function (xhr) {
            //         xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token') /* localStorage.getItem('wedding_token') */ );
            //     }
            // }).done(function(resp) {
            //     console.log(resp);
            //     PerformerViewModel.OffersList([]);
            //     for (const item of resp) {
            //         PerformerViewModel.OffersList.push(item);
            //     }
            //     RootViewModel.PreloaderHide();
            // }).fail(function(xhr, status, text) {
            //     RootViewModel.PreloaderHide();
            //     ShowModalError('#performer', xhr);
            //     //alert("error: " + text);
            // });
        },
        DeleteOffer: function(_offer) {
            // RootViewModel.PreloaderShow();
            // $.ajax({
            //     url: "api/offers/" + _offer.id,
            //     type: 'DELETE',
            //     beforeSend: function (xhr) {
            //         xhr.setRequestHeader("Authorization", 'Bearer '+ Cookies.get('wedding_token') /* localStorage.getItem('wedding_token') */ );
            //     }
            // }).done(function(resp) {
            //     PerformerViewModel.OffersList.remove(_offer);
            //     M.toast({html: 'Успешно удалено!', classes: 'rounded'});
            //     RootViewModel.PreloaderHide();
            // }).fail(function(xhr, status, text) {
            //     RootViewModel.PreloaderHide();
            //     ShowModalError('#performer', xhr);
            //     //alert("error: " + text);
            // });
        }
    }

    // object activation
    ko.applyBindings(AdminViewModel, document.getElementById("admin-div"));

    // update news when main page becomes visible
    $(document).on("AdminVisible", function () {
        AdminViewModel.UpdateUsers();
        AdminViewModel.UpdateCategories();
        AdminViewModel.UpdateOffers();
    });

    // activate tabs
    $(document).ready(function(){
        $('.admin-tabs').tabs();
    });

    $(document).ready(function(){
        $('.materialboxed').materialbox();
    });

    // $(document).ready(function() {
    //     $('input#title-input, textarea#short-descr').characterCounter();
    // });

    // $(document).ready(function(){
    //     $('.fixed-action-btn').floatingActionButton();
    // });
</script>
